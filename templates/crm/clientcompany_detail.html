{% extends "admin/base_site.html" %}

{% load i18n %}

{% block stylesheet %}{% load adminmedia %}{% admin_media_prefix %}css/dashboard.css{% endblock %}

{% block bodyclass %}dashboard{% endblock %}

{% block breadcrumbs %}{% endblock %}

{% block extrajs %}
{% include "core/_jqplot.html" %}
{% endblock %}


{% block title %}{{ company }}{% endblock %}

{% block content %}

{% if request.session.mobile %}
<div data-role="page" data-theme="c">
    <div data-role="header">
        <h1>{{ company }}</h1>
    </div>
    <div data-role="content">
{% else %}
<div id="content-main">
<h1>{{ company }}</h1>

{% with "company-tabs" as tabs %}
    {% include "core/_init_tabs.html" %}
{% endwith %}

<div id="company-tabs">
    <ul>
        <li><a href="#tab-leads">{% trans "Leads" %}</a></li>
        <li><a href="#tab-consultants">{% trans "Consultants" %}</a></li>
        <li><a href="#tab-contacts">{% trans "Client contacts" %}</a></li>
        <li><a href="#tab-rates">{% trans "Rates" %}</a></li>
        <li><a href="#tab-billing">{% trans "Billing" %}</a></li>
        <li><a href="#tab-all-companies">{% trans "All companies list" %}</a></li>
    </ul>

{% endif %}

<div id="tab-leads">


<h2>{% trans "Sales with this client: "%} {{ company.sales|floatformat:-1 }} k€</h2>

<ul>
{% for lead in leads %}
    {% ifchanged lead.client %}
        {% if request.session.mobile %}</ul><ul data-role="listview" data-inset="true" data-theme="c" data-dividertheme="d"><li data-role="list-divider">{% else %}<h2>{% endif %}
        {% if lead.client.contact %}
            <a rel=external href="{% url admin:crm_clientcontact_change lead.client.contact.id %}">{{ lead.client.organisation }} ({{ lead.client.contact }})</a>
        {% else %}
            {{ lead.client }}
        {% endif %}
        {% if request.session.mobile %}</li>{% else %}</h2>{% endif %}
    {% endifchanged %}

    <li><a href="{% url pydici.leads.views.detail lead.id %}">{{ lead }}</a> - {{ lead.start_date|date:"F Y" }} ({{ lead.get_state_display }})</li>
{% endfor %}
</ul>
</div>

<div id="tab-consultants">
{% if consultants %}
    <h2>{% trans "Consultants that work for this company:" %}</h2>
    <ul data-role="listview" data-inset="true" data-theme="c">
    {% for consultant in consultants %}
        <li><a href="{% url pydici.people.views.consultant_detail consultant.id %}">{{ consultant.full_name }}</a></li>
    {% endfor %}
    </ul>
{% endif %}
</div>

{% if not request.session.mobile %}
<div id="tab-contacts">
<br/>
<div class="imodule">
<table>
	<tr>
	    <th>{% trans "Name" %}</th>
	    <th>{% trans "Company" %}</th>
	    <th>{% trans "Function" %}</th>
	    <th>{% trans "Email" %}</th>
	    <th>{% trans "Phone" %}</th>
	    <th>{% trans "Mobile phone" %}</th>
	    <th>{% trans "Fax" %}</th>
	</tr>
    {% for contact in contacts %}
	    <tr {%cycle 'class="row1"' 'class="row2"' %}>
	       <td><a rel=external href="{% url admin:crm_clientcontact_change contact.id %}">{{ contact.name }}</a></td>
	       <td>{{ contact.company }}</td>
	       <td>{{ contact.function }}</td>
	       <td>{{ contact.email }}</td>
	       <td>{{ contact.phone }}</td>
	       <td>{{ contact.mobile_phone }}</td>
	       <td>{{ contact.fax }}</td>
	    </tr>
    {% endfor %}
</table>
</div>
</div>
{% endif %}


<div id="tab-rates">
<h2>{% trans "Used rates for this company" %}</h2>
<ul>
{% for client in clients %}
<li>{{ client.organisation.name }} {% if client.contact %}({{ client.contact }}){% endif %}<ul>
    {% for profil, rate in client.getFinancialConditions %}
        <li>{{ profil }} : {{ rate }} €</li>
    {% empty %}
    {% trans "No rate defined" %}
    {% endfor %}
    </ul></li>
{% endfor %}
</ul>
</div>

<div id="tab-billing">
<ul>
{% for lead in leads %}
    {% ifequal lead.state "WON" %}
        <h2><a href="{% url pydici.leads.views.detail lead.id %}">{{ lead }}</a></h2>
            {% include "billing/_lead_billing.html" %}
            <br/>
    {% endifequal %}
{% endfor %}
</ul>
</div>



{% if not request.session.mobile %}
    <div id="tab-all-companies">
    {% include "crm/_clientcompany_list.html" %}
    </div>
    </div> <!-- End of tabs div -->
{% endif %}
</div>
{% endblock %}