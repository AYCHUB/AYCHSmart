{% extends "admin/base_site.html" %}

{% load i18n %}
{% load permissions_tags %}
{% load pydici_filters %}

{% block stylesheet %}{% load adminmedia %}{% admin_media_prefix %}css/dashboard.css{% endblock %}

{% block bodyclass %}dashboard{% endblock %}

{% block breadcrumbs %}{% endblock %}

{% block title %}{% trans "Expense" %}{% endblock %}

{% block content %}

{% if modify_expense %}
    <h1>{% trans "Modify the expense" %}</h1>
{% else %}
    <h1>{% trans "Add an expense" %}</h1>
{% endif %}

<form enctype="multipart/form-data" action='' method="POST">
    {{ form.non_field_errors }}
    <div class="pydici-expense-col1">
    <div class="pydici-expense">
            <p>{{ form.description.errors }}
            {{ form.description.label_tag }} :
            {{ form.description }}</p>            
            <p>{{ form.amount.errors }}
            {{ form.amount.label_tag }} :
            {{ form.amount }} ({{ form.chargeable.label }}&nbsp;{{ form.chargeable }})</p>
            <p>{{ form.receipt.erros }} {{ form.receipt.label_tag }} : {{ form.receipt }}</p>
     </div></div>
     <div class="pydici-expense-col2">
     <div class="pydici-expense">
            <p>{{ form.category.errors }}
            {{ form.category.label_tag }} :
            {{ form.category }}</p>                        
            <p>{{ form.lead.errors }}
            {{ form.lead.label_tag }} :
            {{ form.lead }}</p>
    </div></div>
    <div style="clear:both"></div>
    <input type="submit" value="{% trans 'Save' %}"/>

</form>

<br/><hr/><br/>

{% if user_expenses %}
<h1>{% trans "My expenses" %}</h1>
<ul>
    {% for expense, state, transitions in user_expenses %}
        {% ifchanged state %}
            <h2>{{ state.name }}</h2>
        {% endifchanged %}
        <li>
        {% with expense as obj %}{% ifhasperm expense_edit %}
            <a href='{% url pydici.expense.views.expenses expense.id %}'>{% endifhasperm %}{{ expense }}{% ifhasperm expense_edit %}</a>{% endifhasperm %}
        {% endwith %}
        {% if expense.receipt %}
            <a href='{% url pydici.expense.views.expense_receipt expense.id %}'><img src='{{ MEDIA_URL }}pydici/receipt.png'/></a>
        {% endif %}

        </li>
    {% endfor %}
</ul>
<br/><hr/><br/>
{% endif %}

{% if managed_expenses %}
    <h1>{% trans "Expenses I manage" %}</h1>
    <ul>
    {% for expense, state, transitions in managed_expenses %}
        {% ifchanged expense.user %}
            <h2>{{ expense.user|link_to_consultant }}</h2>
        {% endifchanged %}
        {% ifchanged state %}
            <h3>{{ state.name }}</h3>
        {% endifchanged %}
        <li>
        {% with expense as obj %}{% ifhasperm expense_edit %}
            <a href='{% url pydici.expense.views.expenses expense.id %}'>{% endifhasperm %}{{ expense }}{% ifhasperm expense_edit %}</a>{% endifhasperm %}
        {% endwith %}

        {% if expense.receipt %}
            <a href='{% url pydici.expense.views.expense_receipt expense.id %}'><img src='{{ MEDIA_URL }}pydici/receipt.png'/></a>
        {% endif %}

        {% if transitions %}
        (
            {% for transition in transitions %}
                <a href='{% url pydici.expense.views.update_expense_state expense.id transition.id %}'>{{ transition }}</a>
                {% if not forloop.last %} / {% endif %}
            {% endfor %}
        )
        {% endif %}
        </li>
    {% endfor %}
    </ul>
{% endif %}

<br/><hr/><br/>
<a href='{% url pydici.expense.views.expenses_history %}'>{% trans "Expenses history" %}</a>
{% endblock %}