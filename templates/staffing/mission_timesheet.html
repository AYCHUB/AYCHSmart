{% extends "staffing/mission_base.html" %}
{% load i18n %}

{% block mission_detail %}
    <h2>{% trans "Timesheet" %}</h2>
    <a href="{% url pydici.staffing.views.mission_staffing mission.id %}" class='changelink'>{% trans "See also the forecast staffing of this mission" %}</a>
    <br/><br/><hr/>
    <div class="timesheet">
    <table>
    <tr>
        <th></th>
        {% for month in timesheet_months %}
            <th>{{ month|date:"M y" }}</th>
        {% endfor %}
        <th>{% trans "Done days" %}</th>
        <th>{% trans "Total (k€)" %}</th>
        <th></th>
        {% for month in staffing_months %}
            <th>{{ month|date:"M y" }}</th>
        {% endfor %}
        <th>{% trans "Days to be done" %}</th>
        <th>{% trans "Total (k€)" %}</th>
    </tr>
    {% for consultant, timesheet, staffing in mission_data %}
        {% ifequal consultant None %}
            <tr align="right" style="font-weight:bold">
            <td>{% trans "Total" %}</td>
            <td>{{ timesheet|join:"</td><td>" }}</td>
            <td></td>
            <td>{{ staffing|join:"</td><td>" }}</td>
        {% else %}
            <tr align="right">        
            <td>{{ consultant }}</td>
            <td>{{ timesheet|join:"</td><td>" }}</td>
            <td></td>
            <td>{{ staffing|join:"</td><td>" }}</td>
        {% endifequal %}
        </tr>
    {% endfor %}
    </table>
    </div>
    <br/>
    {% ifequal mission.nature "PROD" %}
    <h2>{% trans "Profitability" %}</h2>
    <table>
        <tr><td>{% trans "Sold" %}</td>
        <td>{% if mission.price %}{{ mission.price }}  k€
            {% else %} <a href='{% url admin:staffing_mission_change mission.id %}'>{% trans "To be defined" %}</a>
            {% endif %}</td></tr>
        <tr><td>{% trans "Margin" %}</td><td>{{ margin }}  k€</td></tr>
    </table>
    {% endifequal %}
    {% if mission.lead %}
        <h2>{% trans "Billing" %}</h2>
        <div class="timesheet">
        {% if mission.lead.bill_set.all %}
            <table>
            <th>{% trans "Bill id" %}</th>
            <th>{% trans "State" %}</th>
            <th>{% trans "Amount (€ excl tax)" %}</th>
            <th>{% trans "Creation date" %}</th>
            <th>{% trans "Due date" %}</th>
            <th>{% trans "Payment date" %}</th>
            {% for bill in mission.lead.bill_set.all %}
                <tr>
                    <td><a href="{% url admin:billing_bill_change bill.id %}">{{ bill }}</a></td>
                    <td>{{ bill.get_state_display }}</td>
                    <td>{{ bill.amount }}</td>
                    <td>{{ bill.creation_date }}</td>
                    <td>{{ bill.due_date }}</td>
                    <td>{{ bill.payment_date }}</td>
                </tr>
            {% endfor %}
            </table>
        {% else %}
            <p>{% trans "No bill yet" %}</p>
        {% endif %}
        <br/>
        <a href="{% url pydici.billing.views.create_new_bill_from_lead mission.lead.id %}" target="_blank">{% trans "Add a bill for this mission" %}</a>
    </div>
    {% endif %}
{% endblock %}