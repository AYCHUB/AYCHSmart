{% extends "admin/base_site.html" %}

{% load i18n %}
{% load permissions_tags %}
{% load pydici_filters %}

{% block stylesheet %}{% load adminmedia %}{% admin_media_prefix %}css/dashboard.css{% endblock %}

{% block bodyclass %}dashboard{% endblock %}

{% block breadcrumbs %}{% endblock %}

{% block title %}{% trans "Action sets" %}{% endblock %}

{% block content %}

{% for actionset in actionsets %}
    <h1>{% if can_change %}<a href="{% url admin:actionset_actionset_change actionset.id %}">{{ actionset }}</a>{% else %}{{ actionset }}{% endif %}</h1>
    {% if not actionset.active %}<p><strong>{% trans "This actionset is inactive" %}</strong></p>{% endif %}
    <p><em>{{ actionset.description }}</em></p>
    <p><strong>{% trans "Trigger: " %}</strong> {{ actionset.get_trigger_display }}</p>
    <div><form id='form_actionset_launch'>
       {% trans "Launch manually this actionset for user: " %}
       <input id="id_actionset_target_user" type="text"/>
       <input id="id_actionset_target_user" type="submit" value="{% trans 'Ok' %}"/>
       <div id="launch_feedback_{{ actionset.id }}" style="display:inline;"></div>
       </form>
           <script><!--
                $("#id_actionset_target_user").autocomplete('{% url ajax_lookup "user"%}',
                                                      { formatItem: function(row) { return row[2]; },
                                                        formatResult: function(row) { return row[1]; },
                                                        dataType: "text"
                                                      });
                $('#form_actionset_launch').submit(function() {
                    $.get('{% url pydici.actionset.views.launch_actionset actionset.id %}?username='+$('#id_actionset_target_user').val(),
                           process_launch_actionset);
                    return false; // prevent submiting form to browser (which would reload page...)
                });
            --></script>
     </div>
    <ul>
    {% for action in actionset.action_set.all %}
        <li><strong>{% if can_change %}<a href="{% url admin:actionset_action_change action.id %}">{{ action.name }}</a>{% else %}{{ action.name }}{% endif %}</strong> : <em>{{ action.description }}</em></li>
    {% endfor %}
    </ul>
{% endfor %}

<br/><hr/><br/>
{% if perms.actionset.change_actionstate %}
<a href="{% url admin:actionset_actionstate_changelist %}">{% trans "Pending action tracking" %}</a>
{% endif %}

<script type="text/JavaScript">
<!--
    // Functions that process ajax callback
    function process_launch_actionset(data) {
        if (data.error==true) {
            $("#launch_feedback_" + data.id).html("<strong>"+data.errormsg+"</strong>").show();
        }
        else {
            $("#launch_feedback_" + data.id).html("<strong>{% trans 'Action set launched' %}</strong>").show().fadeOut(3000);
        }
    };
-->
</script>

{% endblock %}